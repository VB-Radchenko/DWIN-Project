
//==============================================================================
//---------------------------------Includes-------------------------------------
//==============================================================================
#include "DWIN_APP.h"
#include "DWIN.h"
#include <stdbool.h>
#include "tim.h"
//==============================================================================
//---------------------------------Defines--------------------------------------
//==============================================================================
#define ledDataAdress 0x5006
//==============================================================================
//--------------------------------Variables-------------------------------------
//==============================================================================
extern struct readDataDWIN_P readDataDWIN;
uint32_t PWMData = 0;
//==============================================================================
//--------------------------------PROTOTYPE-------------------------------------
//==============================================================================
uint16_t adress = 0;
uint8_t adress_h,adress_l;
//==============================================================================
//--------------------------------FUNCTIONS-------------------------------------
//==============================================================================

void dwinAppInit()
{

	  HAL_TIM_PWM_Start(&htim2, TIM_CHANNEL_1);
	  TIM2->CCR1=0;
}

void ledPWM()
{
	parsingDWIN();
	readVariableDWIN(0x5006, 1);
	HAL_Delay(1);
	parsingDWIN();
	adress = ledDataAdress;
	adress_h = ((ledDataAdress & 0xFF00)>>8);
	adress_l = ledDataAdress & 0x00FF;
	if (((readDataDWIN.parsingDataDWIN.data[0] == (ledDataAdress & 0xFF00)>>8)) && (readDataDWIN.parsingDataDWIN.data[1] == (ledDataAdress & 0x00F))) // Checking for address match
	{
		PWMData = readDataDWIN.parsingDataDWIN.data[3]<<8 | readDataDWIN.parsingDataDWIN.data[4];
		if (PWMData >= 50)
		{
			PWMData = ((PWMData - 49) * 2000);
			TIM2->CCR1 = PWMData;
			//TIM2->CCR1 = 1000;
		}
		else
		{
			TIM2->CCR1 = 0;
		}
	}
}

//==============================================================================
//---------------------------------END FILE-------------------------------------
//==============================================================================
