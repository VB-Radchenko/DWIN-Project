
//==============================================================================
//---------------------------------Includes-------------------------------------
//==============================================================================
#include "DWIN_APP.h"
#include "DWIN.h"
#include <stdbool.h>
#include "tim.h"
//==============================================================================
//---------------------------------Defines--------------------------------------
//==============================================================================
#define ledDataAdress 0x5006
//==============================================================================
//--------------------------------Variables-------------------------------------
//==============================================================================
extern struct readDataDWIN_P readDataDWIN;
extern struct curveDataDWIN_p curveDataDWIN;
uint32_t PWMData = 0;
//==============================================================================
//--------------------------------PROTOTYPE-------------------------------------
//==============================================================================
uint16_t adress = 0;
uint8_t adress_h,adress_l;
//==============================================================================
//--------------------------------FUNCTIONS-------------------------------------
//==============================================================================

void dwinAppInit()
{

	  HAL_TIM_PWM_Start(&htim2, TIM_CHANNEL_1);
	  TIM2->CCR1=0;
	  memset(curveDataDWIN, 0x00, sizeof(curveDataDWIN));
}

void ledPWM()
{
	parsingDWIN();
	readVariableDWIN(0x5006, 1);
	HAL_Delay(1);
	parsingDWIN();
	adress = ledDataAdress;
	adress_h = ((ledDataAdress & 0xFF00)>>8);
	adress_l = ledDataAdress & 0x00FF;
	if (((readDataDWIN.parsingDataDWIN.data[0] == (ledDataAdress & 0xFF00)>>8)) && (readDataDWIN.parsingDataDWIN.data[1] == (ledDataAdress & 0x00F))) // Checking for address match
	{
		PWMData = readDataDWIN.parsingDataDWIN.data[3]<<8 | readDataDWIN.parsingDataDWIN.data[4];
		if (PWMData >= 50)
		{
			PWMData = ((PWMData - 49) * 2000);
			TIM2->CCR1 = PWMData;
			//TIM2->CCR1 = 1000;
		}
		else
		{
			TIM2->CCR1 = 0;
		}
	}
}

uint8_t cnt = 0;
void curveProcessDWIN()
{
	  if ( i < 180)
	  {

	  /*HAL_Delay(5);
	  writeOneCurveDWIN(0, 1, &i);
	  parsingDWIN();
	  HAL_Delay(5);
	  dataCurves = sin(i*2 * VAL)*127 + 127;
	  writeOneCurveDWIN(1, 1, &dataCurves);
	  parsingDWIN();
	  HAL_Delay(5);
	  dataCurves = cos(i*2 * VAL)*127 + 127;
	  writeOneCurveDWIN(2, 1, &dataCurves);
	  parsingDWIN();
	  HAL_Delay(5);
	  writeOneCurveDWIN(3, 1, &i);
	  parsingDWIN();
	  HAL_Delay(5);
	  dataCurves = sin(i*2 * VAL)*127 + 127;
	  writeOneCurveDWIN(4, 1, &dataCurves);
	  parsingDWIN();
	  HAL_Delay(5);
	  dataCurves = cos(i*2 * VAL)*127 + 127;
	  writeOneCurveDWIN(5, 1, &dataCurves);
	  parsingDWIN();
	  HAL_Delay(5);
	  writeOneCurveDWIN(6, 1, &meandr);
	  parsingDWIN();
	  HAL_Delay(5);
	  writeOneCurveDWIN(7, 1, &meandr);
	  parsingDWIN();
	  HAL_Delay(5);*/

	  }
	  else
	  {
		  i = 0;
	  }
	writeCurveDWIN(&curveDataDWIN);
}
//==============================================================================
//---------------------------------END FILE-------------------------------------
//==============================================================================
